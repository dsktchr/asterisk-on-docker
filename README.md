# Asterisk on Docker

## overview
AsteriskをDockerコンテナ上で動かします。

以下確認済みの内容
- 通話
- luaによるextensions
- EC2上での起動

以下未実施の内容
- pjsipオブジェクトのDB化
- 利用頻度の多いダイアルプラン一通り
- opus codec 対応

<br>
何度も壊して再構築しやすい環境なので、Asteriskを気軽に試したり、調査などに活用していただければと思います。
<br>
当Asteriskイメージは最新バージョンを適用していますが、oldバージョンでAsteriskを構築したい場合は、Dockerファイル
を修正してイメージを構築して下さい。
<br>
あくまでこのリポジトリは私の技術的検証の副産物に近いものでありますので、完全に信用してはいけません。

## How to
基本的には各々が管理しやすいようにしてくれれば良いのですが、一応例だけ示しておきます。
<br>
```
$ docker build -t asterisk:dev .
$ docker run --name asterisk-server --rm --network host asterisk:dev
```

ご自身のDockerHubにビルドしたイメージをpushしてもらえれば、各々に割り振られていEC2上でも動かすことは可能です。
<br>
余力のある人はどうぞ。

## Asteriskのコンテナ化（WIP)

#### WSL2
Asteriskを構築したDockerイメージを`export`して、WSL2用のDistributionとして利用できるように変換しました。
<br>
Asteriskを構築したイメージから作成されているわけですから、ここで動くことが確認できればDocker上でも同様に動作することが確認できるわけです。
<br>
WSL2上で起動するAsteriskにアクセスするには、WSL2上のIPアドレスを知らなければならないので`iproute2`をインストールして自身のIPアドレスを調べてください。
<br>
`eth0`で表示されているところがWSL2へアクセス可能なIPアドレスとなります。
<br>
余談ですが、WSL2は複数のDistributionを持つことができますが、全て同じIPアドレスになります。
<br>
MSが言うには、1つのVMに複数のインスタンス(個々のDistribution)を立ち上げているからとのことです。

### Docker
#### 1. ホスト端末のSIPアプリを含めたアクセスをする場合
Docker内でAsteriskイメージを実行した際に、もし同じホスト端末で立ち上げたSIPアプリでアクセスしようとすると引っかかる問題があるかと思われます。
<br>
普段Dockerを利用する人は基本的に`localhost|127.0.0.1`でコンテナに接続するかもしれません。
<br>
しかしこれで接続してしまうと、端末同士がつながっても（例えばPCとスマホ）音声でやり取りを行うことができなくなります。
<br>
これはSIPメソッドに答えがあります。
<br>
AsteriskのCLIを起動した後、`pjsip set logger on`を入力し、ログを確認してみてください。
<br>
きっとレスポンス先がホスト端末のSIPアプリの場合、`127.0.0.1`が指定されていないでしょうか？
<br>
コンテナ内部では`127.0.0.1`はコンテナ自身のIPアドレスを指します。
<br>
入りはホスト端末でも内部でのコンテキストが変わってしまったのです。
<br>
ホスト端末からのアクセスの際にもホスト端末自身のIPアドレスを介して接続するようにしてください。
<br>
その場合、おそらく`192.168.x.x`でSIPアプリ内でホスト名を設定すると思われます。
<br>
ちなみに上記の内容は見出し通りホスト端末内でSIPアプリを立ち上げて接続する場合に起きる問題であって、例えばスマホを使って接続確認をする場合は問答無用でホスト端末のIPアドレスを指定することになりますから、気にしなくてよいです。
<br>
またファイアウォールの問題も特に遭遇していないので、（MS公式を確認すればわかりますがUDPポートの制限が見当たりませんでした）遭遇した人がいたら教えて下さい（追記してもよいですよ）。

#### 2. Dockerネットワークを考える 
以下の2通りのやり方があります。
```
// パターン1
$ docker run --name asterisk-server --rm -p 5060:5060/udp -p 5060:5060 asterisk:dev

// パターン2
$ docker run --name asterisk-server --rm --network host asterisk:dev
```

##### パターン1について
単純にホストポートとコンテナポートをマッピングする方法です。
<br>
比較的馴染みのある方法ですが、Asterisk等の多量のポートを利用するシステムの場合はあまりよい方法ではありません。
<br>
特に問題となるのがRTPに利用される`10000-20000`の範囲のポートです。
<br>
ネットワークモードが今回のようなBridgeの場合、コンテナ起動時に`iptables(Linuxのファイアウォール)`を利用してポートの設定が行われます。
<br>
つまり`10000-20000`、延べ1万個+αの設定をコンテナ起動時に設定されることになり、起動時のパフォーマンスに影響を与えてしまうようです。
<br>
単なる検証時にはこれでも問題ないでしょうが、実運用を考えると微妙なところでしょうか。
<br>
例えばEC2インスタンス上でコンテナを立ち上げる場合、セキュリティグループがあるのでそちらに任せればよさそうです。

##### パターン2について
ホスト端末のポート等を共有する方法です。
[詳しくはこちら](https://matuand.github.io/docs.docker.jp.onthefly/network/host)
<br>
ユーザーランドプロキシとかいう聞きなれないワードが出てきましたね...
<br>
[こちらの図](https://mapk0y.hatenablog.com/entry/2015/06/20/124752)がなんとなく分かりやすいのではないのでしょうか？（本当に正しいかは判別つきませんが...)

### VOLUMEを考える(WIP)
Dockerize後に気になる問題としては、Asteriskの何をVOLUMEとしてコンテナ外部に持たせるかだと思います。
<br>
これについては私には分からないので、とりあえずたいていの場合、外だししておくlogに関してはコンテナ起動時に、`-v $(pwd)/path/to/log:/var/log/asterisk`を指定すれば良いと思います。
<br>
詳しくはわからないのですが指定の音声ファイルを再生するとかもあると思うので、そのあたりも外だししておくといいのかもしれない？？
<br>
AWS上で動かすとなると、EC2の指定箇所をホスト側のボリュームとして設定し、更にその指定箇所というのはS3にマウントされていて...みたいな形になるのでしょうか？？？

### k8sでAsteriskコンテナを運用する(WIP)
未実施。
コンテナ化はできているのでできるとは思われ。
ただ検証する環境がないので、有用性についての判断がしにくい。
